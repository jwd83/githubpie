<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Language Breakdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  </head>
  <body class="min-h-screen bg-gray-50 flex flex-col items-center p-6">
    <h1 class="text-3xl font-bold mb-6">GitHub Language Breakdown</h1>

    <div
      class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-6"
    >
    <!-- pressing enter should trigger the analyze button -->
      <input
        id="username"
        class="border rounded-lg p-2 w-64"
        placeholder="Enter GitHub username"
        onkeydown="if(event.key === 'Enter') document.getElementById('analyzeBtn').click()"
      />
      <button
        id="analyzeBtn"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
      >
        Analyze
      </button>
      <!-- make a title that shows up after they click analyze -->
      <h2 id="resultTitle" class="text-xl font-semibold mb-4 hidden"></h2>
    </div>

    <p id="status" class="text-gray-600 mb-4"></p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 w-full max-w-5xl">
      <div id="ownedSection" class="bg-white rounded-2xl shadow p-6 hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">
          Owned Repositories
        </h2>
        <p id="ownedTotal" class="text-center text-gray-600 mb-4"></p>
        <canvas id="ownedChart" width="300" height="300"></canvas>
        <table id="ownedTable" class="mt-4 w-full text-sm border-t"></table>
      </div>

      <div id="forkedSection" class="bg-white rounded-2xl shadow p-6 hidden">
        <h2 class="text-xl font-semibold mb-4 text-center">
          Forked Repositories
        </h2>
        <p id="forkedTotal" class="text-center text-gray-600 mb-4"></p>
        <canvas id="forkedChart" width="300" height="300"></canvas>
        <table id="forkedTable" class="mt-4 w-full text-sm border-t"></table>
      </div>
    </div>

    <footer class="mt-10 text-gray-400 text-sm">
      Built using GitHub public API and Chart.js. Made with ❤️ by <a href="https://github.com/jwd83">jwd83</a>
    </footer>

    <script>
      const COLORS = [
        "#0088FE",
        "#00C49F",
        "#FFBB28",
        "#FF8042",
        "#AF19FF",
        "#FF4560",
        "#00E396",
        "#775DD0",
        "#FEB019",
        "#FF4560",
        "#3F51B5",
        "#546E7A",
        "#26A69A",
        "#D10CE8",
      ];

      async function fetchAllRepos(user) {
        let page = 1;
        let allRepos = [];
        while (true) {
          const response = await fetch(
            `https://api.github.com/users/${user}/repos?per_page=100&page=${page}`
          );
          if (!response.ok) throw new Error("User not found or rate limited.");
          const data = await response.json();
          allRepos = allRepos.concat(data);
          if (data.length < 100) break;
          page++;
        }
        return allRepos;
      }

      function getLanguageData(repoList, filterForks) {
        const filtered = repoList.filter((r) => r.fork === filterForks);
        const langCounts = {};
        filtered.forEach((r) => {
          if (r.language)
            langCounts[r.language] = (langCounts[r.language] || 0) + 1;
        });
        const total = filtered.length;
        const data = Object.entries(langCounts).map(([name, value]) => ({
          name,
          value,
        }));
        return { total, data };
      }

      function renderChart(ctxId, data) {
        const ctx = document.getElementById(ctxId);
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: data.map((d) => d.name),
            datasets: [
              {
                data: data.map((d) => d.value),
                backgroundColor: COLORS.slice(0, data.length),
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      function renderTable(tableId, data) {
        const table = document.getElementById(tableId);
        table.innerHTML = `
        <thead><tr class="text-left border-b"><th class="py-1">Language</th><th class="py-1 text-right">Count</th></tr></thead>
        <tbody>
          ${data
            .map(
              (lang) => `
            <tr class="border-b last:border-none">
              <td class="py-1">${lang.name}</td>
              <td class="py-1 text-right">${lang.value}</td>
            </tr>
          `
            )
            .join("")}
        </tbody>
      `;
      }

      document.getElementById("analyzeBtn").onclick = async () => {
        const user = document.getElementById("username").value.trim();
        const status = document.getElementById("status");
        if (!user) return alert("Please enter a GitHub username.");
        // hide the analyze button and username input while loading
        document.getElementById("analyzeBtn").style.display = "none";
        document.getElementById("username").style.display = "none";

        // show the result title
        document.getElementById(
          "resultTitle"
        ).textContent = `Language statistics for ${user}`;
        document.getElementById("resultTitle").classList.remove("hidden");

        status.textContent = "Fetching repositories...";
        try {
          const repos = await fetchAllRepos(user);
          const owned = getLanguageData(repos, false);
          const forked = getLanguageData(repos, true);


          owned.data.sort((a, b) => b.value - a.value);
          forked.data.sort((a, b) => b.value - a.value);



          // add the count for "Other" to owned and forked to account for repos with no language set
            const ownedOtherCount = repos.filter(
                (r) => !r.fork && !r.language
            ).length;
            const forkedOtherCount = repos.filter(
                (r) => r.fork && !r.language
            ).length;

            if (ownedOtherCount > 0) {
                owned.data.push({ name: "Docs/Other", value: ownedOtherCount });
            }
            if (forkedOtherCount > 0) {
                forked.data.push({ name: "Docs/Other", value: forkedOtherCount });
            }


          // Owned
          if (owned.data.length) {
            document.getElementById("ownedSection").classList.remove("hidden");
            document.getElementById(
              "ownedTotal"
            ).textContent = `Total repositories: ${owned.total}`;
            renderChart("ownedChart", owned.data);
            renderTable("ownedTable", owned.data);
          }

          // Forked
          if (forked.data.length) {
            document.getElementById("forkedSection").classList.remove("hidden");
            document.getElementById(
              "forkedTotal"
            ).textContent = `Total repositories: ${forked.total}`;
            renderChart("forkedChart", forked.data);
            renderTable("forkedTable", forked.data);
          }

          status.textContent = `Fetched ${repos.length} repositories.`;
        } catch (err) {
          console.error(err);
          status.textContent = "Error: " + err.message;
        }
      };

      // check on page load for a username in the URL query params and auto-fill and click analyze
      window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const user = params.get("user");
        if (user) {
          document.getElementById("username").value = user;
          document.getElementById("analyzeBtn").click();
        }
      };
    </script>
  </body>
</html>
